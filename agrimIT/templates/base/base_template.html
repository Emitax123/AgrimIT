<html>
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="{% static 'img/favicon.svg' %}" />
    <link rel="shortcut icon" type="image/svg+xml" href="{% static 'img/favicon.svg' %}" />
    <link rel="apple-touch-icon" href="{% static 'img/favicon.svg' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet" />
    <meta charset="utf-8" />
    <title>AgrimIT</title>
  </head>
  <body>
    <!-- COMIENZO NAVBAR -->
    <nav>
      <div class="navbar">
        <div id="logo">
          <a href="{% url 'index' %}"><img src="{% static 'img/logo.png' %}" /></a>
        </div>

        <!-- Botón hamburger para móvil -->
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Menú">
          <span></span>
          <span></span>
          <span></span>
        </button>

        <!-- Overlay para cerrar menú en móvil -->
        <div class="nav-overlay" id="nav-overlay"></div>

        <div class="nav-list" id="nav-list">
          <ul class="nav-dropdown">
            <li>
              <a href="{% url 'index' %}">Inicio</a>
            </li>
            <li>
              <a href="{% url 'projects' %}" data-submenu="projects-submenu">Proyectos</a>
              <ul class="navbar-submenu" id="projects-submenu">
                <li>
                  <a href="{% url 'projects' %}">Todos</a>
                </li>
                <li>
                  <a href="{% url 'projectslisttype' type=1 %}">Mensuras</a>
                </li>
                <li>
                  <a href="{% url 'projectslisttype' type=2 %}">Est.Parcelarios</a>
                </li>
                <li>
                  <a href="{% url 'projectslisttype' type=3 %}">Amojonamientos</a>
                </li>
                <li>
                  <a href="{% url 'projectslisttype' type=4 %}">Relevamientos</a>
                </li>
                <li>
                  <a href="{% url 'projectslisttype' type=5 %}">Legajos</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="{% url 'balance' %}" data-submenu="balance-submenu">Balances</a>
              <ul class="navbar-submenu" id="balance-submenu">
                <li>
                  <a href="{% url 'balance' %}">Resumen</a>
                </li>
                <li>
                  <a href="{% url 'accounting_display' %}">Cobranzas</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="{% url 'history' %}">Historial</a>
            </li>
            <li>
              <a href="{% url 'create' %}">Formulario</a>
            </li>
            <li>
              <a href="{% url 'clients' %}">Clientes</a>
            </li>
            <!-- FORMULARIO DE BÚSQUEDA -->
            <li>
              <form autocomplete="off" method="post" id="search-form" style="display: flex; flex-flow: row;" action="{% url 'projects' %}">
                {% csrf_token %}
                <input autocomplete="off" type="text" id="search-input" name="search-input" placeholder="Buscar proyecto..." />
                <input type="hidden" id="project-link" data-url="{% url 'projectview' pk=0 %}" />
                <button class="search-button" id="search-button" type="submit"><img style="width: 25px; height: 25px;" src="{% static 'img/search-icon.svg' %}" alt="Buscar" /></button>
                <div id="search-results">
                  <!-- This div will be populated with search results -->
                </div>
              </form>
              <div id="results-cont" class="results-cont"></div>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- FIN NAVBAR -->
    <div class="container">
      <div class="fila">
        {% block index %}

        {% endblock %}
        {% block form %}

        {% endblock %}
        {% block graph %}

        {% endblock %}
      </div>
    </div>
  </body>

  <script>
    // Navbar functionality - Complete solution
    document.addEventListener('DOMContentLoaded', function () {
      const hamburgerBtn = document.getElementById('hamburger-btn')
      const navList = document.getElementById('nav-list')
      const navOverlay = document.getElementById('nav-overlay')
      const toggleButtons = document.querySelectorAll('[data-submenu]')
    
      // Hamburger menu functionality
      if (hamburgerBtn && navList && navOverlay) {
        hamburgerBtn.addEventListener('click', function () {
          const isActive = navList.classList.contains('active')
    
          if (isActive) {
            // Cerrar menú
            hamburgerBtn.classList.remove('active')
            navList.classList.remove('active')
            navOverlay.classList.remove('active')
            document.body.style.overflow = ''
          } else {
            // Abrir menú
            hamburgerBtn.classList.add('active')
            navList.classList.add('active')
            navOverlay.classList.add('active')
            document.body.style.overflow = 'hidden'
          }
        })
    
        // Cerrar menú al hacer click en overlay
        navOverlay.addEventListener('click', function () {
          hamburgerBtn.classList.remove('active')
          navList.classList.remove('active')
          navOverlay.classList.remove('active')
          document.body.style.overflow = ''
        })
    
        // Cerrar menú al cambiar tamaño de ventana (si se cambia a desktop)
        window.addEventListener('resize', function () {
          if (window.innerWidth > 768) {
            hamburgerBtn.classList.remove('active')
            navList.classList.remove('active')
            navOverlay.classList.remove('active')
            document.body.style.overflow = ''
    
            // Cerrar todos los submenús en móvil
            document.querySelectorAll('.navbar-submenu').forEach((submenu) => {
              submenu.classList.remove('show')
            })
          }
        })
      }
    
      // Submenu functionality
      toggleButtons.forEach((button) => {
        const submenuId = button.getAttribute('data-submenu')
        const submenu = document.getElementById(submenuId)
    
        if (submenu) {
          // Mobile: Click to toggle - simplificado
          button.addEventListener('click', function (e) {
            if (window.innerWidth <= 768) {
              e.preventDefault()
              e.stopPropagation()
    
              // Cerrar todos los otros submenús
              document.querySelectorAll('.navbar-submenu').forEach((other) => {
                if (other !== submenu) {
                  other.classList.remove('show')
                }
              })
    
              // Toggle del actual
              submenu.classList.toggle('show')
            }
          }) // Desktop: Solo hover functionality
          const parentLi = button.closest('li')
          if (parentLi) {
            let hoverTimeout
    
            parentLi.addEventListener('mouseenter', function () {
              if (window.innerWidth > 768) {
                clearTimeout(hoverTimeout)
                submenu.classList.add('show')
              }
            })
    
            parentLi.addEventListener('mouseleave', function () {
              if (window.innerWidth > 768) {
                hoverTimeout = setTimeout(() => {
                  submenu.classList.remove('show')
                }, 150)
              }
            })
    
            // Cancelar el cierre por hover si el mouse está sobre el submenú
            submenu.addEventListener('mouseenter', function () {
              if (window.innerWidth > 768) {
                clearTimeout(hoverTimeout)
              }
            })
    
            submenu.addEventListener('mouseleave', function () {
              if (window.innerWidth > 768) {
                submenu.classList.remove('show')
              }
            })
          }
        }
      })
    })
    
    // JavaScript for search functionality
    // This script handles the search input, fetches results from the server, and displays them in a dropdown.
    // It also includes debouncing to optimize performance and event listeners for user interactions.
    // The search results are displayed in a dropdown below the input field, and clicking outside the dropdown closes it.
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('search-input')
      const resultsContainer = document.getElementById('results-cont')
      const searchForm = document.getElementById('search-form')
      const projectLinkUrl = document.getElementById('project-link').dataset.url
      let searchTimeout
      let isSearchActive = false
    
      searchInput.addEventListener('keyup', () => {
        const query = searchInput.value.trim()
        if (!query) {
          clearResults()
          isSearchActive = false
          return
        }
    
        clearTimeout(searchTimeout)
        searchTimeout = setTimeout(() => {
          clearResults()
          performSearch(query)
        }, 300)
      })
    
      // Click handlers
      searchInput.addEventListener('click', () => {
        if (isSearchActive) {
          resultsContainer.classList.add('show')
        }
      })
    
      document.addEventListener('click', (event) => {
        if (!searchInput.contains(event.target) && !resultsContainer.contains(event.target)) {
          resultsContainer.classList.remove('show')
        }
      })
    
      // Search functionality
      async function performSearch(query) {
        try {
          const response = await fetch(`/search/?query=${encodeURIComponent(query)}`)
          if (!response.ok) throw new Error('Search failed')
    
          const data = await response.json()
          if (data.results?.length) {
            isSearchActive = true
            displayResults(data.results)
          } else {
            isSearchActive = false
            clearResults()
          }
        } catch (error) {
          console.error('Search error:', error)
          isSearchActive = false
        }
      }
    
      function displayResults(results) {
        clearResults()
    
        const fragment = document.createDocumentFragment()
    
        results.forEach((result) => {
          const link = document.createElement('a')
          link.href = projectLinkUrl.replace('0', result.id)
    
          const titleSpan = document.createElement('span')
          titleSpan.textContent = result.type
    
          const dateSpan = document.createElement('span')
          dateSpan.textContent = result.datecreated
          dateSpan.classList.add('date-search')
    
          link.append(titleSpan, dateSpan)
          fragment.appendChild(link)
        })
    
        const seeMoreButton = document.createElement('button')
        seeMoreButton.className = 'search-button see-more'
        seeMoreButton.textContent = 'Ver más'
        seeMoreButton.onclick = () => searchForm.submit()
        fragment.appendChild(seeMoreButton)
        resultsContainer.appendChild(fragment)
        resultsContainer.classList.add('show')
      }
    
      function clearResults() {
        resultsContainer.innerHTML = ''
        resultsContainer.classList.remove('show')
      }
    })
  </script>
</html>
