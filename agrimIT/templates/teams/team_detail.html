{% extends 'base/base_template.html' %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/teams.css' %}" />
{% endblock %}

{% block content %}
  <div class="container">
    <div class="fila">
      <div class="team-detail-header">
        <div class="team-title-section">
          <h1>{{ team.name }}</h1>
          {% if is_owner %}
            <span class="team-badge owner-badge">Propietario</span>
          {% else %}
            <span class="team-badge member-badge">Miembro</span>
          {% endif %}
        </div>

        {% if is_owner %}
          <div class="team-header-actions">
            <a href="{% url 'team_edit' team.pk %}" class="btn btn-edit">‚úèÔ∏è Editar</a>
            <a href="{% url 'team_delete' team.pk %}" class="btn btn-danger">üóëÔ∏è Eliminar</a>
          </div>
        {% endif %}
      </div>

      {% if messages %}
        <div class="messages-container">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {% if team.description %}
        <div class="team-description-box">
          <h3>Descripci√≥n</h3>
          <p>{{ team.description }}</p>
        </div>
      {% endif %}

      <!-- Informaci√≥n del Propietario -->
      <div class="owner-info-box">
        <h3>üë§ Administrador del Grupo</h3>
        <p>
          <strong>{{ team.owner.get_full_name|default:team.owner.username }}</strong>
        </p>
        <p class="text-muted">Creado el {{ team.created|date:'d/m/Y' }}</p>
      </div>

      <!-- Miembros del Equipo -->
      <div class="members-section">
        <div class="section-header">
          <h2>üë• Miembros del Grupo ({{ members.count }})</h2>
          {% if is_owner and add_member_form %}
            <button type="button" class="btn btn-primary" onclick="toggleAddMemberForm()">‚ûï Agregar Miembro</button>
          {% endif %}
        </div>

        {% if is_owner and add_member_form %}
          <div id="add-member-form" class="add-member-form" style="display: none;">
            <form method="post" action="{% url 'team_add_member' team.pk %}">
              {% csrf_token %}
              <div class="form-inline-group">
                <div class="form-field">
                  <label for="{{ add_member_form.username.id_for_label }}">{{ add_member_form.username.label }}</label>
                  {{ add_member_form.username }}
                </div>
                <div class="form-field">
                  <label for="{{ add_member_form.role.id_for_label }}">{{ add_member_form.role.label }}</label>
                  {{ add_member_form.role }}
                </div>
                <div class="form-actions-inline">
                  <button type="submit" class="btn btn-success">Agregar</button>
                  <button type="button" class="btn btn-secondary" onclick="toggleAddMemberForm()">Cancelar</button>
                </div>
              </div>
            </form>
          </div>
        {% endif %}

        {% if members %}
          <div class="members-list">
            {% for membership in members %}
              <div class="member-card">
                <div class="member-info">
                  <div class="member-avatar">{{ membership.user.username|slice:':1'|upper }}</div>
                  <div class="member-details">
                    <h4>{{ membership.user.get_full_name|default:membership.user.username }}</h4>
                    <p class="member-username">@{{ membership.user.username }}</p>
                    <span class="role-badge role-{{ membership.role }}">{{ membership.get_role_display }}</span>
                  </div>
                </div>
                <div class="member-meta">
                  <p class="join-date">Desde {{ membership.joined_at|date:'d/m/Y' }}</p>
                  {% if is_owner %}
                    <form method="post" action="{% url 'team_remove_member' team.pk membership.pk %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-remove" onclick="return confirm('¬øEliminar a {{ membership.user.username }} del grupo?')">‚úï Remover</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <p>Este grupo no tiene miembros a√∫n.</p>
            {% if is_owner %}
              <p class="hint">Usa el bot√≥n "Agregar Miembro" para comenzar.</p>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Proyectos Compartidos -->
      <div class="shared-projects-section">
        <div class="section-header">
          <h2>üìÅ Proyectos Compartidos ({{ shared_projects.count }})</h2>
        </div>

        {% if shared_projects %}
          <div class="projects-list">
            {% for share in shared_projects %}
              <div class="project-share-card">
                <div class="project-share-info">
                  <h4><a href="{% url 'projectview' share.project.pk %}">{{ share.project.type }} - {{ share.project.titular_name }}</a></h4>
                  <div class="project-meta">
                    <span class="meta-item"><strong>Cliente:</strong> {{ share.project.client.name }}</span>
                    {% if share.project.partida %}
                      <span class="meta-item"><strong>Partida:</strong> {{ share.project.partida }}</span>
                    {% endif %}
                    <span class="meta-item"><strong>Compartido por:</strong> {{ share.shared_by.username }}</span>
                    <span class="meta-item text-muted">{{ share.shared_at|date:'d/m/Y H:i' }}</span>
                  </div>
                  {% if share.notes %}
                    <p class="share-notes">üìù {{ share.notes }}</p>
                  {% endif %}
                </div>
                {% if share.shared_by == user %}
                  <div class="project-share-actions">
                    <form method="post" action="{% url 'project_unshare' share.project.pk share.pk %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-remove-small" onclick="return confirm('¬øDejar de compartir este proyecto?')">‚úï Dejar de Compartir</button>
                    </form>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <p>No hay proyectos compartidos con este grupo a√∫n.</p>
            {% if is_owner %}
              <p class="hint">Ve a cualquier proyecto y comp√°rtelo con este grupo.</p>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <div class="back-link">
        <a href="{% url 'team_list' %}" class="btn btn-secondary">‚Üê Volver a Mis Grupos</a>
      </div>
    </div>
  </div>

  <script>
    function toggleAddMemberForm() {
      const form = document.getElementById('add-member-form')
      form.style.display = form.style.display === 'none' ? 'block' : 'none'
    }
  </script>
{% endblock %}
